{% extends "base.html" %}

{% block title %}{{ website.name }} - 网站详情 - 网页监控系统{% endblock %}

{% block page_title %}
<div class="d-flex align-items-center">
    <div class="avatar-circle bg-primary text-white me-3">
        {{ website.name[0].upper() }}
    </div>
    <div>
        <h4 class="mb-0">{{ website.name }}</h4>
        <small class="text-muted">
            <i class="fas fa-link me-1"></i>
            <a href="{{ website.url }}" target="_blank" class="text-decoration-none">{{ website.url }}</a>
        </small>
    </div>
</div>
{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <a href="{{ url_for('websites') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> 返回列表
    </a>
    <button type="button" class="btn btn-outline-success" onclick="manualCheck()">
        <i class="fas fa-sync-alt"></i> 手动检查
    </button>
    {% if session.role == 'admin' %}
    <button type="button" class="btn btn-outline-warning" onclick="toggleWebsite()">
        <i class="fas fa-power-off"></i> 
        {% if website.enabled %}禁用{% else %}启用{% endif %}
    </button>
    <button type="button" class="btn btn-outline-primary" onclick="editWebsite()">
        <i class="fas fa-edit"></i> 编辑
    </button>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<!-- 网站状态卡片 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="mb-2">
                    {% if website.enabled %}
                    <i class="fas fa-check-circle fa-2x text-success"></i>
                    {% else %}
                    <i class="fas fa-pause-circle fa-2x text-secondary"></i>
                    {% endif %}
                </div>
                <h6 class="card-title">状态</h6>
                <p class="card-text">
                    {% if website.enabled %}
                    <span class="badge bg-success">已启用</span>
                    {% else %}
                    <span class="badge bg-secondary">已禁用</span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="mb-2">
                    <i class="fas fa-clock fa-2x text-primary"></i>
                </div>
                <h6 class="card-title">检查间隔</h6>
                <p class="card-text">
                    <span class="badge bg-primary">{{ website.check_interval }}分钟</span>
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="mb-2">
                    {% if website.last_status_code == 200 %}
                    <i class="fas fa-check-circle fa-2x text-success"></i>
                    {% elif website.last_status_code >= 400 %}
                    <i class="fas fa-exclamation-circle fa-2x text-danger"></i>
                    {% else %}
                    <i class="fas fa-question-circle fa-2x text-warning"></i>
                    {% endif %}
                </div>
                <h6 class="card-title">最后状态</h6>
                <p class="card-text">
                    {% if website.last_status_code %}
                        {% if website.last_status_code == 200 %}
                        <span class="badge bg-success">{{ website.last_status_code }}</span>
                        {% elif website.last_status_code >= 400 %}
                        <span class="badge bg-danger">{{ website.last_status_code }}</span>
                        {% else %}
                        <span class="badge bg-warning">{{ website.last_status_code }}</span>
                        {% endif %}
                    {% else %}
                    <span class="text-muted">未检查</span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="mb-2">
                    <i class="fas fa-tachometer-alt fa-2x text-info"></i>
                </div>
                <h6 class="card-title">响应时间</h6>
                <p class="card-text">
                    {% if website.last_response_time %}
                    <span class="badge bg-info">{{ "%.2f" | format(website.last_response_time) }}s</span>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- 网站配置信息 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-cog me-2"></i>配置信息
                </h6>
            </div>
            <div class="card-body">
                <table class="table table-borderless table-sm">
                    <tr>
                        <td class="text-muted" width="120">网站名称:</td>
                        <td>{{ website.name }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">URL:</td>
                        <td>
                            <a href="{{ website.url }}" target="_blank" class="text-decoration-none">
                                {{ website.url }}
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">检测算法:</td>
                        <td>
                            {% if website.detection_algorithm == 'hash' %}
                            <span class="badge bg-primary">哈希检测</span>
                            {% elif website.detection_algorithm == 'diff' %}
                            <span class="badge bg-info">差异检测</span>
                            {% elif website.detection_algorithm == 'semantic' %}
                            <span class="badge bg-success">语义检测</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ website.detection_algorithm }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">抓取方式:</td>
                        <td>
                            {% if website.use_selenium %}
                            <span class="badge bg-warning">Selenium</span>
                            {% else %}
                            <span class="badge bg-primary">Requests</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% if website.selector %}
                    <tr>
                        <td class="text-muted">CSS选择器:</td>
                        <td><code>{{ website.selector }}</code></td>
                    </tr>
                    {% endif %}
                    {% if website.xpath %}
                    <tr>
                        <td class="text-muted">XPath:</td>
                        <td><code>{{ website.xpath }}</code></td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td class="text-muted">创建时间:</td>
                        <td>{{ website.created_at | datetime }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">最后检查:</td>
                        <td>
                            {% if website.last_check_at %}
                            {{ website.last_check_at | datetime }}
                            <small class="text-muted">({{ website.last_check_at | timedelta }})</small>
                            {% else %}
                            <span class="text-muted">从未检查</span>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-bell me-2"></i>通知设置
                </h6>
            </div>
            <div class="card-body">
                <table class="table table-borderless table-sm">
                    <tr>
                        <td class="text-muted" width="120">通知状态:</td>
                        <td>
                            {% if website.notification_enabled %}
                            <span class="badge bg-success">已启用</span>
                            {% else %}
                            <span class="badge bg-secondary">已禁用</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% if website.notification_emails %}
                    <tr>
                        <td class="text-muted">通知邮箱:</td>
                        <td>
                            {% for email in website.notification_emails %}
                            <span class="badge bg-light text-dark me-1">{{ email }}</span>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endif %}
                    {% if website.webhook_urls %}
                    <tr>
                        <td class="text-muted">Webhook:</td>
                        <td>
                            {% for url in website.webhook_urls %}
                            <div><small class="text-muted">{{ url }}</small></div>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td class="text-muted">通知阈值:</td>
                        <td>
                            <span class="badge bg-info">{{ website.notification_threshold or 0.1 }}</span>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 检查历史图表 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-chart-line me-2"></i>检查历史趋势
                </h6>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="loadChart('24h')" data-period="24h">24小时</button>
                    <button type="button" class="btn btn-outline-primary" onclick="loadChart('7d')" data-period="7d">7天</button>
                    <button type="button" class="btn btn-outline-primary" onclick="loadChart('30d')" data-period="30d">30天</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="historyChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- 变化检测历史 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-history me-2"></i>变化检测历史
                    <span class="badge bg-secondary ms-2" id="changesCount">{{ changes|length }}</span>
                </h6>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="refreshChanges()">
                        <i class="fas fa-sync-alt"></i> 刷新
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="exportChanges()">
                        <i class="fas fa-download"></i> 导出
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                {% if changes %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>检测时间</th>
                                <th>变化类型</th>
                                <th>变化程度</th>
                                <th>状态码</th>
                                <th>响应时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for change in changes %}
                            <tr>
                                <td>
                                    <div>{{ change.detected_at | datetime }}</div>
                                    <small class="text-muted">{{ change.detected_at | timedelta }}</small>
                                </td>
                                <td>
                                    {% if change.change_type == 'content' %}
                                    <span class="badge bg-primary">内容变化</span>
                                    {% elif change.change_type == 'structure' %}
                                    <span class="badge bg-info">结构变化</span>
                                    {% elif change.change_type == 'error' %}
                                    <span class="badge bg-danger">错误</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ change.change_type }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if change.change_score %}
                                    <div class="progress" style="height: 20px; width: 80px;">
                                        <div class="progress-bar 
                                            {% if change.change_score < 0.3 %}bg-success
                                            {% elif change.change_score < 0.7 %}bg-warning
                                            {% else %}bg-danger{% endif %}"
                                             style="width: {{ (change.change_score * 100) | round }}%">
                                            {{ (change.change_score * 100) | round }}%
                                        </div>
                                    </div>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if change.status_code %}
                                        {% if change.status_code == 200 %}
                                        <span class="badge bg-success">{{ change.status_code }}</span>
                                        {% elif change.status_code >= 400 %}
                                        <span class="badge bg-danger">{{ change.status_code }}</span>
                                        {% else %}
                                        <span class="badge bg-warning">{{ change.status_code }}</span>
                                        {% endif %}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if change.response_time %}
                                    <span class="badge bg-light text-dark">{{ "%.2f" | format(change.response_time) }}s</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                onclick="viewChangeDetail({{ change.id }})"
                                                data-bs-toggle="tooltip" title="查看详情">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if change.diff_summary %}
                                        <button type="button" class="btn btn-outline-info btn-sm" 
                                                onclick="viewDiff({{ change.id }})"
                                                data-bs-toggle="tooltip" title="查看差异">
                                            <i class="fas fa-code"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">暂无变化记录</h5>
                    <p class="text-muted">该网站还没有检测到任何变化</p>
                    <button type="button" class="btn btn-gradient" onclick="manualCheck()">
                        <i class="fas fa-sync-alt me-2"></i>立即检查
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 变化详情模态框 -->
<div class="modal fade" id="changeDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>变化详情
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="changeDetailContent">
                <!-- 动态加载内容 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 差异对比模态框 -->
<div class="modal fade" id="diffModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-code me-2"></i>内容差异对比
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="diffContent">
                <!-- 动态加载内容 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .avatar-circle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.5em;
    }
    
    .progress {
        border-radius: 10px;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    .diff-content {
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        white-space: pre-wrap;
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .diff-added {
        background-color: #d4edda;
        color: #155724;
    }
    
    .diff-removed {
        background-color: #f8d7da;
        color: #721c24;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let historyChart;
    const websiteId = {{ website.id }};
    
    $(document).ready(function() {
        // 初始化图表
        loadChart('24h');
        
        // 初始化工具提示
        $('[data-bs-toggle="tooltip"]').tooltip();
    });
    
    // 加载历史图表
    function loadChart(period) {
        // 更新按钮状态
        $('.btn-group button').removeClass('active');
        $(`button[data-period="${period}"]`).addClass('active');
        
        showLoading($('#historyChart').parent());
        
        $.get(`/api/websites/${websiteId}/history`, { period: period })
            .done(function(response) {
                if (response.success) {
                    renderChart(response.data);
                } else {
                    showError('加载历史数据失败');
                }
            })
            .fail(function() {
                showError('加载历史数据失败');
            })
            .always(function() {
                hideLoading($('#historyChart').parent());
            });
    }
    
    // 渲染图表
    function renderChart(data) {
        const ctx = document.getElementById('historyChart').getContext('2d');
        
        if (historyChart) {
            historyChart.destroy();
        }
        
        historyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: '响应时间 (秒)',
                        data: data.response_times,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        yAxisID: 'y'
                    },
                    {
                        label: '状态码',
                        data: data.status_codes,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: '时间'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: '响应时间 (秒)'
                        },
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: '状态码'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: false
                    }
                }
            }
        });
    }
    
    // 手动检查
    function manualCheck() {
        const $btn = $(event.target).closest('button');
        showLoading($btn);
        
        $.post(`/api/websites/${websiteId}/check`)
            .done(function(response) {
                if (response.success) {
                    showSuccess('检查任务已提交');
                    
                    // 检查任务状态
                    checkTaskStatus(response.data.task_id, function() {
                        // 刷新页面数据
                        setTimeout(() => location.reload(), 2000);
                    });
                } else {
                    showError(response.error || '提交检查任务失败');
                }
            })
            .fail(function() {
                showError('提交检查任务失败');
            })
            .always(function() {
                hideLoading($btn);
            });
    }
    
    // 切换网站状态
    function toggleWebsite() {
        const $btn = $(event.target).closest('button');
        showLoading($btn);
        
        $.post(`/api/websites/${websiteId}/toggle`)
            .done(function(response) {
                if (response.success) {
                    showSuccess('网站状态已更新');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showError(response.error || '更新网站状态失败');
                }
            })
            .fail(function() {
                showError('更新网站状态失败');
            })
            .always(function() {
                hideLoading($btn);
            });
    }
    
    // 编辑网站
    function editWebsite() {
        // 跳转到编辑页面或显示编辑模态框
        showInfo('编辑功能开发中...');
    }
    
    // 查看变化详情
    function viewChangeDetail(changeId) {
        showLoading($('#changeDetailContent'));
        $('#changeDetailModal').modal('show');
        
        $.get(`/api/changes/${changeId}`)
            .done(function(response) {
                if (response.success) {
                    const change = response.data;
                    let content = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>基本信息</h6>
                                <table class="table table-borderless table-sm">
                                    <tr><td class="text-muted">检测时间:</td><td>${formatDateTime(change.detected_at)}</td></tr>
                                    <tr><td class="text-muted">变化类型:</td><td><span class="badge bg-primary">${change.change_type}</span></td></tr>
                                    <tr><td class="text-muted">变化程度:</td><td>${change.change_score ? (change.change_score * 100).toFixed(1) + '%' : '-'}</td></tr>
                                    <tr><td class="text-muted">状态码:</td><td>${change.status_code || '-'}</td></tr>
                                    <tr><td class="text-muted">响应时间:</td><td>${change.response_time ? change.response_time.toFixed(2) + 's' : '-'}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6>检测结果</h6>
                                <div class="bg-light p-3 rounded">
                                    <pre class="mb-0">${change.change_summary || '无详细信息'}</pre>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    if (change.error_message) {
                        content += `
                            <div class="mt-3">
                                <h6 class="text-danger">错误信息</h6>
                                <div class="alert alert-danger">
                                    <pre class="mb-0">${change.error_message}</pre>
                                </div>
                            </div>
                        `;
                    }
                    
                    $('#changeDetailContent').html(content);
                } else {
                    $('#changeDetailContent').html('<div class="alert alert-danger">加载变化详情失败</div>');
                }
            })
            .fail(function() {
                $('#changeDetailContent').html('<div class="alert alert-danger">加载变化详情失败</div>');
            })
            .always(function() {
                hideLoading($('#changeDetailContent'));
            });
    }
    
    // 查看差异对比
    function viewDiff(changeId) {
        showLoading($('#diffContent'));
        $('#diffModal').modal('show');
        
        $.get(`/api/changes/${changeId}/diff`)
            .done(function(response) {
                if (response.success) {
                    const diff = response.data.diff;
                    let content = '<div class="diff-content">';
                    
                    diff.split('\n').forEach(line => {
                        if (line.startsWith('+')) {
                            content += `<div class="diff-added">${escapeHtml(line)}</div>`;
                        } else if (line.startsWith('-')) {
                            content += `<div class="diff-removed">${escapeHtml(line)}</div>`;
                        } else {
                            content += `<div>${escapeHtml(line)}</div>`;
                        }
                    });
                    
                    content += '</div>';
                    $('#diffContent').html(content);
                } else {
                    $('#diffContent').html('<div class="alert alert-danger">加载差异对比失败</div>');
                }
            })
            .fail(function() {
                $('#diffContent').html('<div class="alert alert-danger">加载差异对比失败</div>');
            })
            .always(function() {
                hideLoading($('#diffContent'));
            });
    }
    
    // 刷新变化列表
    function refreshChanges() {
        location.reload();
    }
    
    // 导出变化记录
    function exportChanges() {
        window.open(`/api/websites/${websiteId}/export`, '_blank');
    }
    
    // 检查任务状态
    function checkTaskStatus(taskId, callback) {
        const checkStatus = () => {
            $.get(`/api/tasks/${taskId}/status`)
                .done(function(response) {
                    if (response.success) {
                        const status = response.data;
                        
                        if (status.state === 'SUCCESS') {
                            showSuccess('检查完成');
                            if (callback) callback();
                        } else if (status.state === 'FAILURE') {
                            showError('检查失败: ' + (status.result || '未知错误'));
                        } else if (status.state === 'PENDING' || status.state === 'STARTED') {
                            // 继续检查
                            setTimeout(checkStatus, 2000);
                        }
                    }
                })
                .fail(function() {
                    console.error('检查任务状态失败');
                });
        };
        
        setTimeout(checkStatus, 1000);
    }
    
    // HTML转义
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}